<?xml version="1.0" encoding="UTF-8"?>
<dataConfig>
	<dataSource driver="com.mysql.jdbc.Driver" password="password"
		type="JdbcDataSource"
		url="jdbc:mysql://localhost:3306/openmrs?autoReconnect=true&amp;sessionVariables=storage_engine=InnoDB&amp;useUnicode=true&amp;characterEncoding=UTF-8"
		user="openmrs" />
	<document>
		<entity name="obs"
			query="SELECT  o.uuid as id,  obs_id,	 person_id,  obs_datetime, obs_group_id, cn1.name as concept_name, cn2.name as coded, value_boolean,  value_datetime, value_numeric, value_text, cc.concept_class_name, cn3.name AS concept_synonym FROM openmrs.obs o 
				INNER JOIN (SELECT * FROM openmrs.concept_name c WHERE c.locale = 'en' AND concept_name_type = 'FULLY_SPECIFIED') AS cn1 ON cn1.concept_id = o.concept_id 
				LEFT JOIN (SELECT * FROM openmrs.concept_name c WHERE c.locale = 'en' AND concept_name_type = 'FULLY_SPECIFIED') AS cn2 ON cn2.concept_id = o.value_coded
				LEFT JOIN  (SELECT * FROM openmrs.concept_name c WHERE c.locale = 'en' AND concept_name_type IS NULL) AS cn3 ON cn3.concept_id = o.concept_id
				LEFT JOIN (SELECT DISTINCT o.concept_id, class.name AS concept_class_name FROM concept_class class 
				JOIN concept c ON c.class_id = class.concept_class_id
				JOIN obs o ON o.concept_id = c.concept_id) AS cc ON cc.concept_id = o.concept_id 
			WHERE person_id='${dataimporter.request.personId}' AND o.voided=0 AND cn1.voided=0"

			deltaImportQuery="SELECT  o.uuid as id,  obs_id,	 person_id,  obs_datetime, obs_group_id, cn1.name as concept_name, cn2.name as coded, value_boolean,  value_datetime, value_numeric, value_text, cc.concept_class_name, cn3.name AS concept_synonym FROM openmrs.obs o 
				INNER JOIN (SELECT * FROM openmrs.concept_name c WHERE c.locale = 'en' AND concept_name_type = 'FULLY_SPECIFIED') AS cn1 ON cn1.concept_id = o.concept_id 
				LEFT JOIN (SELECT * FROM openmrs.concept_name c WHERE c.locale = 'en' AND concept_name_type = 'FULLY_SPECIFIED') AS cn2 ON cn2.concept_id = o.value_coded
				LEFT JOIN  (SELECT * FROM openmrs.concept_name c WHERE c.locale = 'en' AND concept_name_type IS NULL) AS cn3 ON cn3.concept_id = o.concept_id
				LEFT JOIN (SELECT DISTINCT o.concept_id, class.name AS concept_class_name FROM concept_class class 
				JOIN concept c ON c.class_id = class.concept_class_id
				JOIN obs o ON o.concept_id = c.concept_id) AS cc ON cc.concept_id = o.concept_id 
			WHERE o.uuid='${dih.delta.id}' AND o.voided=0 AND cn1.voided=0"

			deltaQuery="select o.uuid as id from openmrs.obs o 
				inner join concept_name cn on cn.concept_id = o.concept_id
				where person_id='${dataimporter.request.personId}'
				AND o.voided=0 AND cn.voided=0
				AND o.date_created &gt; '${dataimporter.request.lastIndexTime}'"

			deletedPkQuery="select o.uuid as id from openmrs.obs o 
				inner join concept_name cn on cn.concept_id = o.concept_id
				where person_id='${dataimporter.request.personId}'
				AND (o.voided=1 OR cn.voided=1) AND o.date_voided &gt; '${dataimporter.request.lastIndexTime}'">
		</entity>
		<entity name="encounters"
			query="SELECT e.uuid as id, e.encounter_id, e.patient_id, et.name as encounter_type, e.form_id as e_form_id, e.encounter_datetime , e.visit_id
				FROM openmrs.encounter e
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = e.encounter_type
				WHERE e.voided = '0' AND e.patient_id = '${dataimporter.request.personId}'"

			deltaImportQuery="SELECT e.uuid as id, e.encounter_id, e.patient_id, et.name as encounter_type, e.form_id as e_form_id, e.encounter_datetime , e.visit_id
				FROM openmrs.encounter e
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = e.encounter_type
				WHERE e.voided = '0' AND e.uuid='${dih.delta.id}'"

			deltaQuery="select e.uuid as id FROM openmrs.encounter e
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = e.encounter_type
				WHERE e.voided = '0' AND e.patient_id = '${dataimporter.request.personId}'
				AND e.date_created &gt; '${dataimporter.request.lastIndexTime}'"

			deletedPkQuery="select e.uuid as id FROM openmrs.encounter e
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = e.encounter_type
				WHERE e.voided = '1' AND e.date_voided &gt; '${dataimporter.request.lastIndexTime}'">
		</entity>
		<entity name="forms"
			query="SELECT f.uuid as id, form_id, f.name as form_name, f.date_created, et.name as encounter_type_name
				FROM openmrs.form f 
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = f.encounter_type 
				WHERE f.retired = 0"

			deltaImportQuery="SELECT f.uuid as id, form_id, f.name as form_name, f.date_created, et.name as encounter_type_name
				FROM openmrs.form f 
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = f.encounter_type
				WHERE f.uuid='${dih.delta.id}' AND f.retired = 0"

			deltaQuery="select f.uuid as id from openmrs.form f
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = f.encounter_type
				where f.retired = 0
				AND f.date_created &gt; '${dataimporter.request.lastIndexTime}'"

			deletedPkQuery="select f.uuid as id from openmrs.form f
				INNER JOIN openmrs.encounter_type et ON et.encounter_type_id = f.encounter_type
				where f.retired = 1">
		</entity>

		<entity name="allergies"
			query="SELECT DISTINCT a.uuid AS id, a.allergy_id AS allergy_id, ac1.name AS allergy_coded_name, a.non_coded_allergen AS allergy_non_coded_name,
					ac2.name AS allergy_severity, a.allergen_type AS allergy_type, ar2.name AS allergy_coded_reaction, ar2.reaction_non_coded AS allergy_non_coded_reaction, a.comment AS allergy_comment FROM allergy a
				JOIN (SELECT cn1.name, a1.coded_allergen, a1.non_coded_allergen FROM concept_name cn1 INNER JOIN (SELECT DISTINCT coded_allergen, non_coded_allergen FROM allergy) AS a1 ON a1.coded_allergen = cn1.concept_id WHERE cn1.locale='en') AS ac1 ON ac1.coded_allergen = a.coded_allergen
				LEFT JOIN (SELECT cn2.name, a2.severity_concept_id FROM concept_name cn2 INNER JOIN (SELECT DISTINCT severity_concept_id FROM allergy) AS a2 ON cn2.concept_id = a2.severity_concept_id WHERE cn2.locale='en') AS ac2 ON ac2.severity_concept_id = a.severity_concept_id
				LEFT JOIN (SELECT cn.name, ar.allergy_id, ar.reaction_non_coded FROM concept_name cn INNER JOIN (SELECT DISTINCT allergy_id, reaction_concept_id, reaction_non_coded FROM allergy_reaction) AS ar ON ar.reaction_concept_id = cn.concept_id  WHERE cn.locale='en') AS ar2 ON ar2.allergy_id = a.allergy_id
				WHERE a.patient_id ='${dataimporter.request.personId}'"

			deltaImportQuery="SELECT DISTINCT a.uuid AS id, a.allergy_id AS allergy_id, ac1.name AS allergy_coded_name, a.non_coded_allergen AS allergy_non_coded_name,
					ac2.name AS allergy_severity, a.allergen_type AS allergy_type, ar2.name AS allergy_coded_reaction, ar2.reaction_non_coded AS allergy_non_coded_reaction, a.comment AS allergy_comment FROM allergy a
				JOIN (SELECT cn1.name, a1.coded_allergen, a1.non_coded_allergen FROM concept_name cn1 INNER JOIN (SELECT DISTINCT coded_allergen, non_coded_allergen FROM allergy) AS a1 ON a1.coded_allergen = cn1.concept_id WHERE cn1.locale='en') AS ac1 ON ac1.coded_allergen = a.coded_allergen
				LEFT JOIN (SELECT cn2.name, a2.severity_concept_id FROM concept_name cn2 INNER JOIN (SELECT DISTINCT severity_concept_id FROM allergy) AS a2 ON cn2.concept_id = a2.severity_concept_id WHERE cn2.locale='en') AS ac2 ON ac2.severity_concept_id = a.severity_concept_id
				LEFT JOIN (SELECT cn.name, ar.allergy_id, ar.reaction_non_coded FROM concept_name cn INNER JOIN (SELECT DISTINCT allergy_id, reaction_concept_id, reaction_non_coded FROM allergy_reaction) AS ar ON ar.reaction_concept_id = cn.concept_id  WHERE cn.locale='en') AS ar2 ON ar2.allergy_id = a.allergy_id
				WHERE a.uuid='${dih.delta.id}'"

			deltaQuery="SELECT a.uuid as id from openmrs.allergy a 
				INNER JOIN concept_name cn on cn.concept_id = a.coded_allergen
				WHERE patient_id='${dataimporter.request.personId}'
				AND a.voided=0 AND cn.voided=0
				AND a.date_created &gt; '${dataimporter.request.lastIndexTime}"

			deletedPkQuery="SELECT a.uuid as id from openmrs.allergy a 
				INNER JOIN concept_name cn on cn.concept_id = a.coded_allergen
				WHERE patient_id='${dataimporter.request.personId}'
				AND (a.voided=1 OR cn.voided=1) AND a.date_voided &gt; '${dataimporter.request.lastIndexTime}'">
		</entity>

	</document>
</dataConfig>